let t=!1;window.onload=()=>{playerColor=localStorage.getItem("color")||"white",game.reset(),initBoard(n,i),playerColor==="black"&&setTimeout(()=>a(),500),updateStatus("游戏开始，等待你的操作")};function n(e,o){if(game.game_over()||game.turn()!==playerColor[0]||game.move({from:e,to:o,promotion:"q"})===null)return"snapback";board.position(game.fen()),updateStatus("等待 AI 思考..."),setTimeout(()=>a(),300)}function i(e){if(game.game_over()||game.turn()!==playerColor[0])return;const o=game.get(e);selectedSquare?game.move({from:selectedSquare,to:e,promotion:"q"})===null?o&&o.color===game.turn()?(selectedSquare=e,highlightSquare(e)):(selectedSquare=null,removeHighlight()):(board.position(game.fen()),selectedSquare=null,removeHighlight(),updateStatus("等待 AI 思考..."),setTimeout(()=>a(),300)):o&&o.color===game.turn()&&(selectedSquare=e,highlightSquare(e))}function a(){t||game.game_over()||(t=!0,fetch("/move",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fen:game.fen(),mode:"ai"})}).then(e=>e.json()).then(e=>{if(t=!1,e.best_move){const o={from:e.best_move.slice(0,2),to:e.best_move.slice(2,4),promotion:"q"};game.move(o),board.position(game.fen()),updateStatus("你的回合")}else updateStatus("AI 无法走棋")}).catch(e=>{t=!1,updateStatus("AI 请求失败"),console.error(e)}))}
