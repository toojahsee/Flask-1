let i,o=new Chess,n=null;function g(t){return new URLSearchParams(window.location.search).get(t)}let r=g("color")||"white";window.onload=()=>{const t=document.getElementById("board"),e=document.getElementById("colorSelect"),l=document.getElementById("sizeRange"),c=document.getElementById("sizeValue");e&&(e.value=r,e.addEventListener("change",s=>{r=s.target.value,b()})),d(),t.addEventListener("touchmove",s=>{s.preventDefault()},{passive:!1}),l&&c&&l.addEventListener("input",s=>{const f=s.target.value;c.textContent=f,t.style.width=f+"px",i.resize()})};function d(){i=Chessboard("board",{draggable:!0,position:"start",orientation:r,onDrop:h,onSnapEnd:()=>i.position(o.fen()),onSquareClick:p,onDragStart:v}),r==="black"&&setTimeout(u,500)}function v(t,e,l,c){if(o.game_over()||o.turn()!==r[0]||r==="white"&&!e.startsWith("w")||r==="black"&&!e.startsWith("b"))return!1}function h(t,e){if(o.turn()!==r[0]||o.move({from:t,to:e,promotion:"q"})===null)return"snapback";i.position(o.fen()),setTimeout(u,250)}function p(t){if(o.turn()!==r[0])return;const e=o.get(t);n===null?e&&e.color===o.turn()&&(n=t,m(t)):t===n?(n=null,a()):o.move({from:n,to:t,promotion:"q"})===null?e&&e.color===o.turn()?(n=t,m(t)):(n=null,a()):(i.position(o.fen()),n=null,a(),setTimeout(u,250))}function m(t){a();const e=document.querySelector(`#board .square-${t}`);e&&(e.style.background="rgba(255, 255, 0, 0.6)")}function a(){document.querySelectorAll("#board .square-55d63").forEach(t=>{t.style.background=""})}function u(){if(o.game_over())return;const t=o.fen();fetch("/move",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fen:t})}).then(e=>e.json()).then(e=>{e.best_move?(o.move({from:e.best_move.slice(0,2),to:e.best_move.slice(2,4),promotion:"q"}),i.position(o.fen())):e.error&&console.error("AI 错误：",e.error)}).catch(e=>console.error("请求AI失败：",e))}function b(){o.reset(),n=null,i.destroy(),d()}
