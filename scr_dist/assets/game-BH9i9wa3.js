const t=io(),y=new URLSearchParams(window.location.search),u=y.get("room")||localStorage.getItem("room");u||(alert("无效房间，请返回主页重新进入。"),window.location.href="/");localStorage.setItem("room",u);let a=null,n=new Chess,r=null,s=!1,i=!1,f=!1;window.boardInitialized=!1;function g(e){if(window.boardInitialized){a.orientation(e),a.position(n.fen());return}a=Chessboard("board",{draggable:!0,position:"start",orientation:e,onDrop:w,moveSpeed:"fast",snapbackSpeed:100,snapSpeed:80,pieceTheme:"/static/img/chesspieces/wikipedia/{piece}.png"}),window.boardInitialized=!0}function p(e=[]){const o=l=>e.find(d=>d.color===l);["white","black"].forEach(l=>{const d=o(l),m=document.getElementById(`${l}-status`);m&&(d?(m.textContent=d.ready?"已就绪":"已加入",m.style.color=d.ready?"green":""):(m.textContent="等待中...",m.style.color=""))})}function c(){const e=document.getElementById("status");if(!e)return;n.in_checkmate()?e.textContent=`将死！游戏结束。你${s?"输了":"赢了"}`:n.in_draw()||n.in_stalemate()||n.insufficient_material()?e.textContent="平局。":n.in_check()?e.textContent=s?"你的回合（被将军）":"对方回合（你将军）":e.textContent=s?"你的回合":"对方回合";const o=document.getElementById("restartBtn");o&&(o.disabled=!n.game_over())}function w(e,o){if(!i||!s||n.game_over()||f)return"snapback";f=!0;const l=n.move({from:e,to:o,promotion:"q"});if(!l)return f=!1,"snapback";a.position(n.fen()),t.emit("move",{room:u,move:l}),s=!1,c(),setTimeout(()=>{f=!1},300)}function B(){t.on("connect",()=>{t.emit("join",{room:u}),console.log(`[Socket] 已连接，加入房间 ${u}`)}),t.on("joined",e=>{if(r=e.your_color,!r){alert("房间已满或服务器错误，未分配颜色。"),window.location.href="/";return}localStorage.setItem("color",r),g(r),i=e.ready,s=r==="white"&&i,document.getElementById("status").textContent=`你是 ${r==="white"?"白棋":"黑棋"}`,document.getElementById("restartBtn").disabled=!0,p(e.players),c()}),t.on("player_joined",e=>{p(e.players)}),t.on("ready",e=>{if(!e||!e.color)return;const o=document.getElementById(`${e.color}-status`);o&&(o.textContent="已就绪",o.style.color="green")}),t.on("player_left",e=>{p(e.players),document.getElementById("status").textContent="对手已离开房间。",i=!1,document.getElementById("restartBtn").disabled=!0}),t.on("start",e=>{g(r),n.reset(),a.start(),i=!0,s=r==="white",p(e.players),document.getElementById("status").textContent=`对局开始！你执 ${r==="white"?"白棋":"黑棋"}`,c(),document.getElementById("restartBtn").disabled=!0}),t.on("move",e=>{if(!e||!e.move)return;n.move(e.move)?(a.position(n.fen()),s=!0,c()):console.error("[Error] 收到无效走子：",e.move)}),t.on("opponent_left",()=>{document.getElementById("status").textContent="对手已离开房间。",i=!1,document.getElementById("restartBtn").disabled=!0}),t.on("restart",()=>{n.reset(),a.start(),s=r==="white",i=!0,c()}),t.on("room_full",e=>{alert(e.message||"房间已满或错误，请稍后再试。"),window.location.href="/"}),t.on("error",e=>{console.error("[Socket Error]",e)}),t.on("disconnect",e=>{console.warn(`[Socket] 断开连接: ${e}`)})}function E(){const e=document.getElementById("restartBtn");e&&e.addEventListener("click",()=>{confirm("确定要重新开始游戏吗？")&&(n.reset(),a.start(),s=r==="white",i=!0,c(),t.emit("restart",{room:u}))})}function h(){B(),E()}h();function I(e){console.log(`连接游戏，房间号：${e}`)}window.connectGame=I;
