const o=io(),d=new URLSearchParams(window.location.search),s=d.get("room")||localStorage.getItem("room"),a=d.get("color")||localStorage.getItem("color")||"white";s||(alert("无效房间或颜色，请返回主页重新进入。"),window.location.href="/");localStorage.setItem("room",s);localStorage.setItem("color",a);let c=null,e=new Chess,n=a==="white";function g(){c=Chessboard("board",{draggable:!0,position:"start",orientation:a,onDrop:f,moveSpeed:"fast",snapbackSpeed:100,snapSpeed:80,pieceTheme:"/static/img/chesspieces/wikipedia/{piece}.png"})}function f(t,l){if(!n||e.game_over())return"snapback";const i=e.move({from:t,to:l,promotion:"q"});if(!i)return"snapback";o.emit("move",{room:s,move:i}),n=!1,r()}o.on("connect",()=>{o.emit("join",{room:s,color:a}),console.log(`[Socket] 已连接，加入房间 ${s}，颜色 ${a}`)});o.on("move",t=>{e.move(t.move),c.position(e.fen()),n=!0,r()});o.on("room_full",t=>{alert(t.message||"房间已满或颜色已被选，请选择其他颜色或重新进入。"),window.location.href="/"});o.on("joined",t=>{u(t.players),t.players.length===2&&(document.getElementById("status").textContent="双方已连接，准备开始对局...")});o.on("start",t=>{document.getElementById("status").textContent="对局开始！你执"+(a==="white"?"白":"黑")+"棋",u(t.players),r(),document.getElementById("restartBtn").disabled=!0});o.on("opponent_left",()=>{document.getElementById("status").textContent="对手已离开房间。",document.getElementById("restartBtn").disabled=!0});o.on("restart",()=>{e.reset(),c.start(),n=a==="white",r()});document.getElementById("restartBtn").addEventListener("click",()=>{confirm("确定要重新开始游戏吗？")&&(e.reset(),c.start(),n=a==="white",r(),o.emit("restart",{room:s}))});function r(){const t=document.getElementById("status");e.in_checkmate()?t.textContent="将死！游戏结束。你"+(n?"输了":"赢了"):e.in_draw()?t.textContent="平局。":e.in_check()?t.textContent=n?"你的回合（被将军）":"对方回合（你将军）":t.textContent=n?"你的回合":"对方回合",document.getElementById("restartBtn").disabled=!e.game_over()}function u(t){const l=t.find(m=>m.color==="white"),i=t.find(m=>m.color==="black");document.getElementById("white-status").textContent=l?"已连接":"等待中...",document.getElementById("black-status").textContent=i?"已连接":"等待中..."}g();
